<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô - Student Care</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/notification.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', sans-serif; 
            background: #f5f5f7;
            -webkit-font-smoothing: antialiased;
            padding: 24px;
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
        }
        
        .card { 
            background: rgba(255,255,255,0.8);
            backdrop-filter: blur(40px) saturate(180%);
            -webkit-backdrop-filter: blur(40px) saturate(180%);
            border-radius: 16px; 
            padding: 32px; 
            margin-bottom: 16px;
            border: 1px solid rgba(0,0,0,0.06);
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
        }
        
        h1 {
            font-size: 28px;
            font-weight: 600;
            color: #1d1d1f;
            text-align: center;
            margin-bottom: 8px;
            letter-spacing: -0.5px;
        }
        
        .subtitle {
            text-align: center;
            color: #86868b;
            margin-bottom: 32px;
            font-size: 15px;
        }
        
        .form-group { margin-bottom: 20px; }
        .form-group label { 
            display: block; 
            margin-bottom: 8px; 
            font-weight: 600; 
            color: #1d1d1f;
            font-size: 13px;
        }
        .form-group input { 
            width: 100%; 
            padding: 12px; 
            border: 1px solid rgba(0,0,0,0.1); 
            border-radius: 10px;
            font-size: 15px;
            background: rgba(255,255,255,0.8);
            transition: all 0.2s;
        }
        .form-group input:focus { 
            outline: none; 
            border-color: #007aff;
            box-shadow: 0 0 0 3px rgba(0,122,255,0.1);
        }
        
        .btn { 
            width: 100%;
            padding: 14px; 
            border: none; 
            border-radius: 12px; 
            cursor: pointer; 
            font-weight: 600; 
            transition: all 0.2s;
            font-size: 15px;
            margin: 8px 0;
        }
        .btn-primary { background: #007aff; color: white; }
        .btn-primary:hover { background: #0051d5; transform: scale(1.01); }
        .btn-success { background: #34c759; color: white; }
        .btn-danger { background: #ff3b30; color: white; }
        
        #video { 
            width: 100%; 
            border-radius: 12px; 
            background: #000;
            margin: 16px 0;
        }
        #canvas { display: none; }
        
        #preview {
            text-align: center;
            margin: 16px 0;
        }
        #preview img {
            max-width: 100%;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .info-box {
            background: rgba(0,122,255,0.1);
            border-left: 3px solid #007aff;
            padding: 16px;
            border-radius: 8px;
            margin: 16px 0;
            font-size: 13px;
            color: #1d1d1f;
        }
        
        .student-info {
            background: rgba(52,199,89,0.1);
            padding: 16px;
            border-radius: 10px;
            margin: 16px 0;
            display: none;
        }
        .student-info h3 {
            color: #34c759;
            font-size: 16px;
            margin-bottom: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h1>üì∏ ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h1>
            <p class="subtitle">‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
            
            <div class="info-box">
                <strong>üìã ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô:</strong><br>
                1. ‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô<br>
                2. ‡∏Å‡∏î‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤<br>
                3. ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ<br>
                4. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
            </div>
            
            <form id="searchForm" onsubmit="searchStudent(event)">
                <div class="form-group">
                    <label>‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô:</label>
                    <input type="text" id="studentId" placeholder="‡πÄ‡∏ä‡πà‡∏ô STD001" required>
                </div>
                <button type="submit" class="btn btn-primary">üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
            </form>
            
            <div id="studentInfo" class="student-info">
                <h3>‚úÖ ‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
                <p><strong>‡∏ä‡∏∑‡πà‡∏≠:</strong> <span id="studentName"></span></p>
                <p><strong>‡∏´‡πâ‡∏≠‡∏á:</strong> <span id="studentClass"></span></p>
            </div>
            
            <div id="cameraSection" style="display: none;">
                <video id="video" autoplay></video>
                <canvas id="canvas"></canvas>
                <div id="preview"></div>
                
                <button class="btn btn-primary" onclick="startCamera()">üì∑ ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á</button>
                <button class="btn btn-success" onclick="capturePhoto()">üì∏ ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ</button>
                <button class="btn btn-danger" onclick="retakePhoto()">üîÑ ‡∏ñ‡πà‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà</button>
                <button class="btn btn-primary" onclick="savePhoto()" id="saveBtn" style="display: none;">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</button>
                
                <div id="lineSection" style="display: none; margin-top: 24px; padding: 16px; background: rgba(6,214,160,0.1); border-radius: 10px;">
                    <h3 style="font-size: 16px; margin-bottom: 12px; color: #06d6a0;">üíö ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á LINE</h3>
                    <p style="font-size: 13px; margin-bottom: 12px; color: #1d1d1f;">‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ö‡∏∏‡∏ï‡∏£‡πÄ‡∏Ç‡πâ‡∏≤-‡∏≠‡∏≠‡∏Å‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</p>
                    
                    <div id="lineStatus" style="margin-bottom: 12px; padding: 12px; background: rgba(255,255,255,0.5); border-radius: 8px;">
                        <p style="font-size: 13px; color: #666;">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: <span id="lineStatusText">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</span></p>
                    </div>
                    
                    <button class="btn btn-success" onclick="connectLINE()" id="connectBtn">üíö ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE</button>
                    <button class="btn btn-primary" onclick="testLINE()" id="testBtn" style="display: none;">üì§ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</button>
                    <p style="font-size: 12px; margin-top: 8px; color: #86868b;">‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà‡πÄ‡∏°‡∏ô‡∏π "‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ LINE OA"</p>
                </div>
            </div>
        </div>
    </div>

    <script src="/static/notification.js"></script>
    <script>
        let currentStudent = null;
        let capturedImage = null;

        async function searchStudent(e) {
            e.preventDefault();
            
            const studentId = document.getElementById('studentId').value.trim();
            
            try {
                const res = await fetch('/api/students');
                const data = await res.json();
                
                if (!data.success) {
                    showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ', 'error');
                    return;
                }
                
                const student = data.students.find(s => s.student_id === studentId);
                
                if (student) {
                    currentStudent = student;
                    document.getElementById('studentName').textContent = student.name;
                    document.getElementById('studentClass').textContent = student.class_name || '-';
                    document.getElementById('studentInfo').style.display = 'block';
                    document.getElementById('cameraSection').style.display = 'block';
                    showToast('‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ' + student.name, 'success');
                } else {
                    // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏ö ‡πÉ‡∏´‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà
                    const name = prompt('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•:');
                    if (name) {
                        currentStudent = {
                            student_id: studentId,
                            name: name,
                            class_name: ''
                        };
                        document.getElementById('studentName').textContent = name;
                        document.getElementById('studentClass').textContent = '-';
                        document.getElementById('studentInfo').style.display = 'block';
                        document.getElementById('cameraSection').style.display = 'block';
                        showToast('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà: ' + name, 'success');
                    }
                }
            } catch (error) {
                showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
            }
        }

        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                document.getElementById('video').srcObject = stream;
                showToast('‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß', 'success');
            } catch (err) {
                showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á: ' + err, 'error');
            }
        }

        function capturePhoto() {
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            
            if (!video.videoWidth) {
                showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô!', 'error');
                return;
            }
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            
            capturedImage = canvas.toDataURL('image/jpeg', 0.8);
            document.getElementById('preview').innerHTML = '<img src="' + capturedImage + '">';
            document.getElementById('saveBtn').style.display = 'block';
            
            showToast('‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô', 'success');
        }

        function retakePhoto() {
            capturedImage = null;
            document.getElementById('preview').innerHTML = '';
            document.getElementById('saveBtn').style.display = 'none';
            showToast('‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢', 'info');
        }

        async function savePhoto() {
            if (!capturedImage || !currentStudent) {
                showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏Å‡πà‡∏≠‡∏ô', 'error');
                return;
            }
            
            const formData = new FormData();
            formData.append('student_id', currentStudent.student_id);
            formData.append('name', currentStudent.name);
            formData.append('class_name', currentStudent.class_name || '');
            formData.append('image_data', capturedImage);
            
            try {
                const res = await fetch('/add_student', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await res.json();
                
                if (result.success) {
                    showToast('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
                    
                    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ LINE
                    await checkLINEStatus();
                    
                    // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏ï‡πà‡∏≠ LINE
                    document.getElementById('saveBtn').style.display = 'none';
                    document.getElementById('lineSection').style.display = 'block';
                } else {
                    showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + result.message, 'error');
                }
            } catch (error) {
                showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
            }
        }
        
        async function checkLINEStatus() {
            if (!currentStudent) return;
            
            try {
                const res = await fetch(`/api/student/${currentStudent.student_id}`);
                const data = await res.json();
                
                if (data.success && data.student.parent_line_token) {
                    document.getElementById('lineStatusText').textContent = '‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß';
                    document.getElementById('lineStatusText').style.color = '#34c759';
                    document.getElementById('connectBtn').style.display = 'none';
                    document.getElementById('testBtn').style.display = 'block';
                } else {
                    document.getElementById('lineStatusText').textContent = '‚ùå ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠';
                    document.getElementById('lineStatusText').style.color = '#ff3b30';
                    document.getElementById('connectBtn').style.display = 'block';
                    document.getElementById('testBtn').style.display = 'none';
                }
            } catch (error) {
                console.error('Check LINE status error:', error);
            }
        }
        
        async function testLINE() {
            if (!currentStudent) return;
            
            try {
                const res = await fetch('/api/line/test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ student_id: currentStudent.student_id })
                });
                
                const result = await res.json();
                
                if (result.success) {
                    showToast('‚úÖ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö LINE', 'success');
                } else {
                    showToast('‚ùå ' + result.message, 'error');
                }
            } catch (error) {
                showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
            }
        }
        
        async function connectLINE() {
            if (!currentStudent) return;
            
            // ‡∏î‡∏∂‡∏á LINE OA ID ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤
            try {
                const res = await fetch('/api/line/config');
                const data = await res.json();
                
                let lineOAID = '@YOUR_LINE_OA_ID';
                if (data.success && data.config && data.config.line_oa_id) {
                    lineOAID = data.config.line_oa_id;
                } else {
                    lineOAID = prompt('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å LINE OA ID (‡πÄ‡∏ä‡πà‡∏ô @abc1234):');
                    if (!lineOAID) return;
                }
                
                // ‡πÄ‡∏õ‡∏¥‡∏î LINE OA ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
                const lineUrl = `https://line.me/R/ti/p/${lineOAID}?text=${encodeURIComponent(currentStudent.student_id)}`;
                window.open(lineUrl, '_blank');
                
                showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÉ‡∏ô LINE ‡πÅ‡∏•‡πâ‡∏ß‡∏™‡πà‡∏á‡∏£‡∏´‡∏±‡∏™: ' + currentStudent.student_id, 'success');
                
                // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏´‡∏•‡∏±‡∏á 3 ‡∏ß‡∏¥
                setTimeout(() => {
                    document.getElementById('searchForm').reset();
                    document.getElementById('studentInfo').style.display = 'none';
                    document.getElementById('cameraSection').style.display = 'none';
                    document.getElementById('preview').innerHTML = '';
                    document.getElementById('lineSection').style.display = 'none';
                    capturedImage = null;
                    currentStudent = null;
                    
                    const video = document.getElementById('video');
                    if (video.srcObject) {
                        video.srcObject.getTracks().forEach(track => track.stop());
                    }
                }, 3000);
            } catch (error) {
                const lineOAID = prompt('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å LINE OA ID (‡πÄ‡∏ä‡πà‡∏ô @abc1234):');
                if (!lineOAID) return;
                
                const lineUrl = `https://line.me/R/ti/p/${lineOAID}?text=${encodeURIComponent(currentStudent.student_id)}`;
                window.open(lineUrl, '_blank');
                showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÉ‡∏ô LINE ‡πÅ‡∏•‡πâ‡∏ß‡∏™‡πà‡∏á‡∏£‡∏´‡∏±‡∏™: ' + currentStudent.student_id, 'success');
            }
        }
    </script>
</body>
</html>
