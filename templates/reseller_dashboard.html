<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reseller Dashboard - Student Care</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Kanit', sans-serif; background: linear-gradient(135deg, #FF6B6B 0%, #FF8E53 100%); min-height: 100vh; }
        .navbar { background: rgba(255,255,255,0.95); padding: 20px 40px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .container { max-width: 1400px; margin: 30px auto; padding: 0 20px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); text-align: center; }
        .stat-card h3 { font-size: 48px; color: #FF6B6B; margin: 10px 0; }
        .card { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .btn { background: linear-gradient(135deg, #FF6B6B 0%, #FF8E53 100%); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #e0e0e0; }
        th { background: #f8f9fa; font-weight: 600; }
        .badge { padding: 5px 15px; border-radius: 20px; font-size: 14px; font-weight: 600; }
        .badge-active { background: #d4edda; color: #155724; }
        .badge-expired { background: #f8d7da; color: #721c24; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; overflow-y: auto; }
        .modal-content { background: white; width: 90%; max-width: 900px; margin: 50px auto; border-radius: 20px; padding: 40px; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .close-btn { font-size: 32px; cursor: pointer; color: #999; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; }
        .form-group input, .form-group select { width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-family: 'Kanit', sans-serif; font-size: 16px; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: #FF6B6B; }
        .form-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }
        .full-width { grid-column: 1 / -1; }
        .package-cards { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 10px; }
        .package-card { border: 3px solid #e0e0e0; padding: 20px; border-radius: 12px; cursor: pointer; text-align: center; transition: all 0.3s; }
        .package-card:hover { border-color: #FF6B6B; transform: translateY(-5px); box-shadow: 0 5px 15px rgba(255, 107, 107, 0.3); }
        .package-card.selected { border-color: #FF6B6B; background: #fff5f5; box-shadow: 0 5px 20px rgba(255, 107, 107, 0.5); }
        .package-card h4 { color: #FF6B6B; margin-bottom: 10px; font-size: 20px; }
        .package-card .price { font-size: 24px; font-weight: 700; color: #333; margin: 10px 0; }
        .package-card .capacity { color: #666; font-size: 14px; }
    </style>
</head>
<body>
    <nav class="navbar">
        <h1>ü§ù Reseller Dashboard</h1>
        <div>
            <span id="resellerName">Reseller</span> | 
            <a href="/logout" style="color: #333; text-decoration: none;">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</a>
        </div>
    </nav>

    <div class="container">
        <div class="stats-grid">
            <div class="stat-card">
                <p>üì¶ ‡πÅ‡∏û‡πá‡∏Ñ‡πÄ‡∏Å‡πá‡∏à‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
                <h3 id="packageName">-</h3>
            </div>
            <div class="stat-card">
                <p>üè´ ‡∏Ç‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
                <h3 id="maxSchools">0</h3>
            </div>
            <div class="stat-card">
                <p>‚úÖ ‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß</p>
                <h3 id="schoolsUsed">0</h3>
            </div>
            <div class="stat-card">
                <p>üìä ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏≠‡∏µ‡∏Å</p>
                <h3 id="schoolsRemaining">0</h3>
            </div>
            <div class="stat-card">
                <p>üí∞ Commission</p>
                <h3 id="commission">‡∏ø0</h3>
            </div>
            <div class="stat-card">
                <p>üìÖ ‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</p>
                <h3 id="expireDate" style="font-size: 24px;">-</h3>
            </div>
        </div>

        <div class="card">
            <h2>üè´ ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß</h2>
            <button class="btn" onclick="openAddSchoolModal()" id="addSchoolBtn">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà</button>
            
            <table id="schoolsTable">
                <thead>
                    <tr>
                        <th>‡∏£‡∏´‡∏±‡∏™</th>
                        <th>‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th>
                        <th>‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</th>
                        <th>‡πÅ‡∏û‡πá‡∏Ñ‡πÄ‡∏Å‡πá‡∏à</th>
                        <th>‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</th>
                        <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td colspan="6" style="text-align: center;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr>
                </tbody>
            </table>
        </div>

        <div class="card">
            <h2>üí° ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</h2>
            <ul style="line-height: 2;">
                <li>‚úÖ ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ç‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î <strong id="maxSchoolsInfo">0</strong> ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</li>
                <li>üí∞ Commission ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ <strong id="commissionRate">0%</strong> ‡∏à‡∏≤‡∏Å‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</li>
                <li>üìû ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ Super Admin ‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏° Quota</li>
                <li>üîÑ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Commission ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</li>
            </ul>
        </div>
    </div>

    <!-- Modal ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô -->
    <div id="addSchoolModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà</h2>
                <span class="close-btn" onclick="closeAddSchoolModal()">&times;</span>
            </div>
            
            <form id="addSchoolForm" onsubmit="submitSchool(event)">
                <div class="form-group full-width">
                    <label>üì¶ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏û‡πá‡∏Ñ‡πÄ‡∏Å‡πá‡∏à *</label>
                    <div class="package-cards">
                        <div class="package-card" onclick="selectPackage('Starter', 100)">
                            <div style="font-size: 36px;">üè´</div>
                            <h4>Starter</h4>
                            <div class="capacity">1-100 ‡∏Ñ‡∏ô</div>
                            <div class="price">‡∏ø990/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</div>
                        </div>
                        <div class="package-card" onclick="selectPackage('Professional', 500)">
                            <div style="font-size: 36px;">üè´</div>
                            <h4>Professional</h4>
                            <div class="capacity">101-500 ‡∏Ñ‡∏ô</div>
                            <div class="price">‡∏ø2,990/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</div>
                        </div>
                        <div class="package-card" onclick="selectPackage('Business', 2000)">
                            <div style="font-size: 36px;">üè´</div>
                            <h4>Business</h4>
                            <div class="capacity">501-2,000 ‡∏Ñ‡∏ô</div>
                            <div class="price">‡∏ø7,990/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</div>
                        </div>
                    </div>
                    <input type="hidden" id="schoolPackage" name="package" required>
                    <input type="hidden" id="schoolMaxStudents" name="max_students" required>
                </div>

                <div class="form-group full-width">
                    <label>üè´ ‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô *</label>
                    <input type="text" name="name" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏≠‡∏ô‡∏∏‡∏ö‡∏≤‡∏•‡∏ö‡πâ‡∏≤‡∏ô‡∏™‡∏ß‡∏ô" required>
                </div>

                <div class="form-grid">
                    <div class="form-group">
                        <label>üìç ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î *</label>
                        <input type="text" name="province" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£" required>
                    </div>

                    <div class="form-group">
                        <label>üìÖ ‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ *</label>
                        <input type="date" id="schoolExpireDate" name="expire_date" required>
                    </div>
                </div>

                <div class="form-group full-width">
                    <label>üìç ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</label>
                    <input type="text" name="address" placeholder="‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô">
                </div>

                <hr style="margin: 30px 0; border: none; border-top: 2px solid #e0e0e0;">
                <h3 style="margin-bottom: 20px;">üë§ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Admin ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>

                <div class="form-grid">
                    <div class="form-group">
                        <label>üë§ Username *</label>
                        <input type="text" name="admin_username" placeholder="admin" required>
                    </div>

                    <div class="form-group">
                        <label>üîí Password *</label>
                        <input type="password" name="admin_password" placeholder="********" required>
                    </div>
                </div>

                <div class="form-group full-width" style="margin-top: 30px;">
                    <button type="submit" class="btn" style="width: 100%; padding: 15px; font-size: 18px;">‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const username = '{{ session.get("user") }}';
        
        function loadResellerData() {
            // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• reseller ‡∏à‡∏≤‡∏Å username
            fetch('/api/reseller/me')
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        const r = data.reseller;
                        const c = data.commission;
                        
                        currentResellerId = r.reseller_id;
                        maxSchoolsLimit = r.max_schools;
                        schoolsUsedCount = r.schools_used || 0;
                        
                        document.getElementById('resellerName').textContent = r.name;
                        document.getElementById('packageName').textContent = r.package;
                        document.getElementById('maxSchools').textContent = r.max_schools;
                        document.getElementById('schoolsUsed').textContent = schoolsUsedCount;
                        document.getElementById('schoolsRemaining').textContent = r.max_schools - schoolsUsedCount;
                        document.getElementById('commission').textContent = '‡∏ø' + (c.commission || 0).toLocaleString();
                        document.getElementById('expireDate').textContent = r.expire_date;
                        document.getElementById('maxSchoolsInfo').textContent = r.max_schools;
                        document.getElementById('commissionRate').textContent = c.commission_rate + '%';
                        
                        // ‡∏õ‡∏¥‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏ñ‡πâ‡∏≤‡πÄ‡∏ï‡πá‡∏° Quota
                        if (schoolsUsedCount >= maxSchoolsLimit) {
                            document.getElementById('addSchoolBtn').style.opacity = '0.5';
                            document.getElementById('addSchoolBtn').style.cursor = 'not-allowed';
                        }
                        
                        loadSchools(data.schools);
                    }
                });
        }
        
        function loadSchools(schools) {
            const tbody = document.querySelector('#schoolsTable tbody');
            if (schools && schools.length > 0) {
                tbody.innerHTML = schools.map(s => `
                    <tr>
                        <td>${s.school_id}</td>
                        <td><strong>${s.name}</strong></td>
                        <td>${s.province || '-'}</td>
                        <td>${s.package}</td>
                        <td>${s.expire_date}</td>
                        <td><span class="badge badge-${s.status === 'active' ? 'active' : 'expired'}">${s.status === 'active' ? '‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô' : '‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏'}</span></td>
                    </tr>
                `).join('');
            } else {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</td></tr>';
            }
        }
        
        let currentResellerId = null;
        let maxSchoolsLimit = 0;
        let schoolsUsedCount = 0;
        
        function openAddSchoolModal() {
            if (schoolsUsedCount >= maxSchoolsLimit) {
                alert('‚ùå ‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏ä‡πâ Quota ‡πÄ‡∏ï‡πá‡∏°‡πÅ‡∏•‡πâ‡∏ß!\n\n‡∏Ç‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î: ' + maxSchoolsLimit + ' ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ Super Admin ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏° Quota');
                return;
            }
            document.getElementById('addSchoolModal').style.display = 'block';
        }
        
        function closeAddSchoolModal() {
            document.getElementById('addSchoolModal').style.display = 'none';
            document.getElementById('addSchoolForm').reset();
            document.querySelectorAll('.package-card').forEach(card => card.classList.remove('selected'));
        }
        
        function selectPackage(name, capacity) {
            document.querySelectorAll('.package-card').forEach(card => card.classList.remove('selected'));
            event.currentTarget.classList.add('selected');
            
            document.getElementById('schoolPackage').value = name;
            document.getElementById('schoolMaxStudents').value = capacity;
            
            const expireDate = new Date();
            expireDate.setFullYear(expireDate.getFullYear() + 1);
            document.getElementById('schoolExpireDate').value = expireDate.toISOString().split('T')[0];
        }
        
        function submitSchool(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const data = Object.fromEntries(formData.entries());
            data.max_students = parseInt(data.max_students);
            data.status = 'active';
            data.reseller_id = currentResellerId;
            
            fetch('/api/reseller/schools', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert('‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!\n‡∏£‡∏´‡∏±‡∏™: ' + data.school_id);
                    closeAddSchoolModal();
                    loadResellerData();
                } else {
                    alert('‚ùå ' + data.message);
                }
            });
        }
        
        loadResellerData();
    </script>
</body>
</html>
