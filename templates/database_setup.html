<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Database - Student Care</title>
    <link rel="stylesheet" href="/static/global.css">
    <style>
        body { background: #f5f7fa; }
        .container { max-width: 800px; margin: 50px auto; padding: 20px; }
        .setup-card { background: white; border-radius: 15px; padding: 40px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        .header { text-align: center; margin-bottom: 40px; }
        .header h1 { color: #667eea; font-size: 2.5em; margin-bottom: 10px; }
        .db-type { display: flex; gap: 20px; margin-bottom: 30px; }
        .db-option { flex: 1; padding: 20px; border: 2px solid #e0e0e0; border-radius: 10px; cursor: pointer; text-align: center; transition: all 0.3s; }
        .db-option:hover { border-color: #667eea; }
        .db-option.active { border-color: #667eea; background: #f8f9ff; }
        .db-icon { font-size: 3em; margin-bottom: 10px; }
        .form-group { margin-bottom: 25px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; }
        .form-control { width: 100%; padding: 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 1em; }
        .form-control:focus { outline: none; border-color: #667eea; }
        .btn { padding: 15px 30px; border: none; border-radius: 10px; font-size: 1.1em; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; width: 100%; }
        .btn-primary:hover { transform: scale(1.02); }
        .btn-test { background: #28a745; color: white; margin-bottom: 15px; }
        .alert { padding: 15px; border-radius: 10px; margin-bottom: 20px; display: none; }
        .alert-success { background: #d4edda; color: #155724; }
        .alert-error { background: #f8d7da; color: #721c24; }
        .alert-info { background: #d1ecf1; color: #0c5460; }
        .status { text-align: center; margin-top: 20px; padding: 15px; border-radius: 10px; display: none; }
        .status.connected { background: #d4edda; color: #155724; }
        .status.disconnected { background: #f8d7da; color: #721c24; }
        .help-text { font-size: 0.9em; color: #666; margin-top: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="setup-card">
            <div class="header">
                <h1>üóÑÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Database</h1>
                <p>‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö MySQL, PostgreSQL ‡∏´‡∏£‡∏∑‡∏≠ AWS RDS</p>
            </div>

            <div id="alert" class="alert"></div>

            <!-- Database Type Selection -->
            <div class="db-type">
                <div class="db-option active" onclick="selectDbType('sqlite')">
                    <div class="db-icon">üì¶</div>
                    <strong>SQLite</strong>
                    <p style="font-size: 0.9em; color: #666;">Local Database</p>
                </div>
                <div class="db-option" onclick="selectDbType('mysql')">
                    <div class="db-icon">üê¨</div>
                    <strong>MySQL</strong>
                    <p style="font-size: 0.9em; color: #666;">Local/RDS</p>
                </div>
                <div class="db-option" onclick="selectDbType('postgresql')">
                    <div class="db-icon">üêò</div>
                    <strong>PostgreSQL</strong>
                    <p style="font-size: 0.9em; color: #666;">Local/RDS</p>
                </div>
            </div>

            <!-- SQLite Info -->
            <div id="sqlite-info" style="display: block;">
                <div class="alert alert-info" style="display: block;">
                    <strong>‚ÑπÔ∏è SQLite (‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô)</strong><br>
                    ‡πÉ‡∏ä‡πâ‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ö Local ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°<br>
                    ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö: ‡∏ó‡∏î‡∏™‡∏≠‡∏ö, ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏•‡πá‡∏Å (‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô < 500 ‡∏Ñ‡∏ô)
                </div>
            </div>

            <!-- MySQL/PostgreSQL Form -->
            <div id="mysql-form" style="display: none;">
                <form id="dbForm">
                    <div class="form-group">
                        <label>üåê Database Host/URL</label>
                        <input type="text" class="form-control" id="dbHost" placeholder="localhost ‡∏´‡∏£‡∏∑‡∏≠ xxx.rds.amazonaws.com" required>
                        <div class="help-text">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö AWS RDS: ‡πÉ‡∏ä‡πâ Endpoint ‡∏à‡∏≤‡∏Å RDS Console</div>
                    </div>

                    <div class="form-group">
                        <label>üî¢ Port</label>
                        <input type="number" class="form-control" id="dbPort" value="3306" required>
                        <div class="help-text" id="portHelp">MySQL ‡πÉ‡∏ä‡πâ port 3306, PostgreSQL ‡πÉ‡∏ä‡πâ 5432</div>
                    </div>

                    <div class="form-group">
                        <label>üìÅ Database Name</label>
                        <input type="text" class="form-control" id="dbName" value="student_care" required>
                        <div class="help-text">‡∏ä‡∏∑‡πà‡∏≠ database ‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß</div>
                    </div>

                    <div class="form-group">
                        <label>üë§ Username</label>
                        <input type="text" class="form-control" id="dbUser" placeholder="admin" required>
                    </div>

                    <div class="form-group">
                        <label>üîê Password</label>
                        <input type="password" class="form-control" id="dbPassword" required>
                    </div>

                    <button type="button" class="btn btn-test" onclick="testConnection()">üß™ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</button>
                    <button type="submit" class="btn btn-primary">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</button>
                </form>

                <div id="status" class="status"></div>
            </div>

            <!-- Current Status -->
            <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                <strong>üìä ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô:</strong>
                <div id="currentStatus" style="margin-top: 10px;">
                    <div>Database: <span id="currentDb">SQLite</span></div>
                    <div>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: <span id="currentConnection" style="color: #28a745;">‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß</span></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let selectedType = 'sqlite';

        function selectDbType(type) {
            selectedType = type;
            
            // Update UI
            document.querySelectorAll('.db-option').forEach(el => el.classList.remove('active'));
            event.target.closest('.db-option').classList.add('active');

            // Show/Hide forms
            if (type === 'sqlite') {
                document.getElementById('sqlite-info').style.display = 'block';
                document.getElementById('mysql-form').style.display = 'none';
            } else {
                document.getElementById('sqlite-info').style.display = 'none';
                document.getElementById('mysql-form').style.display = 'block';
                
                // Update port and placeholder
                if (type === 'postgresql') {
                    document.getElementById('dbPort').value = '5432';
                    document.getElementById('dbHost').placeholder = 'localhost ‡∏´‡∏£‡∏∑‡∏≠ xxx.rds.amazonaws.com';
                    document.getElementById('portHelp').textContent = 'PostgreSQL ‡πÉ‡∏ä‡πâ port 5432 (default)';
                } else {
                    document.getElementById('dbPort').value = '3306';
                    document.getElementById('dbHost').placeholder = 'localhost ‡∏´‡∏£‡∏∑‡∏≠ xxx.rds.amazonaws.com';
                    document.getElementById('portHelp').textContent = 'MySQL ‡πÉ‡∏ä‡πâ port 3306 (default)';
                }
            }
        }

        async function testConnection() {
            const config = {
                type: selectedType,
                host: document.getElementById('dbHost').value,
                port: document.getElementById('dbPort').value,
                database: document.getElementById('dbName').value,
                user: document.getElementById('dbUser').value,
                password: document.getElementById('dbPassword').value
            };

            showAlert('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...', 'info');

            try {
                const response = await fetch('/api/database/test', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(config)
                });

                const result = await response.json();

                if (result.success) {
                    showAlert('‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
                    document.getElementById('status').className = 'status connected';
                    document.getElementById('status').textContent = '‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
                    document.getElementById('status').style.display = 'block';
                } else {
                    showAlert('‚ùå ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + result.message, 'error');
                    document.getElementById('status').className = 'status disconnected';
                    document.getElementById('status').textContent = '‚ùå ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
                    document.getElementById('status').style.display = 'block';
                }
            } catch (error) {
                showAlert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
            }
        }

        document.getElementById('dbForm').onsubmit = async (e) => {
            e.preventDefault();

            const config = {
                type: selectedType,
                host: document.getElementById('dbHost').value,
                port: document.getElementById('dbPort').value,
                database: document.getElementById('dbName').value,
                user: document.getElementById('dbUser').value,
                password: document.getElementById('dbPassword').value
            };

            showAlert('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤...', 'info');

            try {
                const response = await fetch('/api/database/save', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(config)
                });

                const result = await response.json();

                if (result.success) {
                    showAlert('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Å‡∏≥‡∏•‡∏±‡∏á reload...', 'success');
                    setTimeout(() => {
                        window.location.href = '/admin';
                    }, 2000);
                } else {
                    showAlert('‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + result.message, 'error');
                }
            } catch (error) {
                showAlert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
            }
        };

        function showAlert(message, type) {
            const alert = document.getElementById('alert');
            alert.className = 'alert alert-' + type;
            alert.textContent = message;
            alert.style.display = 'block';
        }

        // Load current config
        async function loadCurrentConfig() {
            try {
                const response = await fetch('/api/database/current');
                const result = await response.json();
                
                if (result.success) {
                    document.getElementById('currentDb').textContent = result.type.toUpperCase();
                    if (result.connected) {
                        document.getElementById('currentConnection').innerHTML = '‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß';
                        document.getElementById('currentConnection').style.color = '#28a745';
                    } else {
                        document.getElementById('currentConnection').innerHTML = '‚ùå ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠';
                        document.getElementById('currentConnection').style.color = '#dc3545';
                    }
                }
            } catch (error) {
                console.error('Error loading config:', error);
            }
        }

        loadCurrentConfig();
    </script>
</body>
</html>
