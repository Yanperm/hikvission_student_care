"""
‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô Hikvision Face Recognition API
"""

from hikvision_face_api import init_hikvision

# ========================================
# 1. ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏•‡πâ‡∏≠‡∏á
# ========================================

# ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô IP, Username, Password ‡∏Ç‡∏≠‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏à‡∏£‡∏¥‡∏á
camera = init_hikvision(
    ip='192.168.1.64',
    username='admin',
    password='your_password'
)

# ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠
if camera.test_connection():
    print("‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!")
else:
    print("‚ùå ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à")
    exit()

# ========================================
# 2. ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
# ========================================

# ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
result = camera.add_face(
    student_id='STD001',
    name='‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ',
    image_path='data/students/STD001.jpg'
)
print(result['message'])

# ========================================
# 3. Sync ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
# ========================================

students = [
    {'student_id': 'STD001', 'name': '‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ', 'image_path': 'data/students/STD001.jpg'},
    {'student_id': 'STD002', 'name': '‡∏™‡∏°‡∏´‡∏ç‡∏¥‡∏á ‡∏£‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô', 'image_path': 'data/students/STD002.jpg'},
    {'student_id': 'STD003', 'name': '‡∏™‡∏°‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå ‡∏Ç‡∏¢‡∏±‡∏ô', 'image_path': 'data/students/STD003.jpg'},
]

result = camera.sync_all_students(students)
print(f"Sync ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: {result['success']}/{result['total']} ‡∏Ñ‡∏ô")

# ========================================
# 4. ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏ô‡∏Å‡∏•‡πâ‡∏≠‡∏á
# ========================================

result = camera.get_face_list()
if result['success']:
    print(f"‡∏°‡∏µ‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏ô‡∏Å‡∏•‡πâ‡∏≠‡∏á {len(result['faces'])} ‡∏Ñ‡∏ô:")
    for face in result['faces']:
        print(f"  - {face['name']} ({face['id']})")

# ========================================
# 5. ‡∏£‡∏±‡∏ö Event ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏ö‡∏ö Real-time
# ========================================

def on_face_detected(result):
    """‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏à‡∏±‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÑ‡∏î‡πâ"""
    print(f"üéØ ‡∏à‡∏±‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤: {result['name']}")
    print(f"   ‡∏£‡∏´‡∏±‡∏™: {result['student_id']}")
    print(f"   ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥: {result['confidence']*100:.1f}%")
    print(f"   ‡πÄ‡∏ß‡∏•‡∏≤: {result['timestamp']}")
    
    # ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
    # db.add_attendance(result['student_id'], result['name'], ...)

# ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏±‡∏ö Event (‡∏à‡∏∞‡∏£‡∏±‡∏ô‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á)
print("üé• ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏≠‡∏à‡∏±‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤...")
camera.get_face_detection_events(callback=on_face_detected)

# ========================================
# 6. ‡∏•‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤
# ========================================

result = camera.delete_face('STD001')
print(result['message'])

# ========================================
# 7. ‡∏î‡∏∂‡∏á RTSP Stream (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠)
# ========================================

rtsp_url = camera.get_rtsp_url()
print(f"RTSP URL: {rtsp_url}")

# ‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ö OpenCV
import cv2
cap = cv2.VideoCapture(rtsp_url)
ret, frame = cap.read()
if ret:
    cv2.imshow('Camera', frame)
    cv2.waitKey(0)
cap.release()
